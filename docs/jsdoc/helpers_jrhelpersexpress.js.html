<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>helpers/jrhelpersexpress.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-controllers_aclaid-AclAid.html">AclAid</a></li></ul><h3>Modules</h3><ul><li><a href="module-controllers_aclaid.html">controllers/aclaid</a></li><li><a href="module-helpers_jrcrypto.html">helpers/jrcrypto</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrcrypto.html#~createHashedObjectFromString">createHashedObjectFromString</a></li><li data-type='method'><a href="module-helpers_jrcrypto.html#~generateRandomSalt">generateRandomSalt</a></li><li data-type='method'><a href="module-helpers_jrcrypto.html#~genRandomStringHex">genRandomStringHex</a></li><li data-type='method'><a href="module-helpers_jrcrypto.html#~genRandomStringHumanEasier">genRandomStringHumanEasier</a></li><li data-type='method'><a href="module-helpers_jrcrypto.html#~genRandomStringHumanEasy">genRandomStringHumanEasy</a></li><li data-type='method'><a href="module-helpers_jrcrypto.html#~hashPlaintextPasswordToObj">hashPlaintextPasswordToObj</a></li><li data-type='method'><a href="module-helpers_jrcrypto.html#~hashPlaintextStringInsecureButSearchable">hashPlaintextStringInsecureButSearchable</a></li><li data-type='method'><a href="module-helpers_jrcrypto.html#~testPlaintextPassword">testPlaintextPassword</a></li></ul></li><li><a href="module-helpers_jrhandlebars.html">helpers/jrhandlebars</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrhandlebars.html#~loadPartialFiles">loadPartialFiles</a></li><li data-type='method'><a href="module-helpers_jrhandlebars.html#~setupJrHandlebarHelpers">setupJrHandlebarHelpers</a></li></ul></li><li><a href="module-helpers_jrhelpers.html">helpers/jrhelpers</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrhelpers.html#~asyncAwaitForEachFunctionCall">asyncAwaitForEachFunctionCall</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~createObjectFromJsonParse">createObjectFromJsonParse</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~DateNowPlusMinutes">DateNowPlusMinutes</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~deepIterationCopy">deepIterationCopy</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~firstCoercedTrueValue">firstCoercedTrueValue</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~getNiceNowString">getNiceNowString</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~getNonFalseValueOrDefault">getNonFalseValueOrDefault</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~getPreciseNowString">getPreciseNowString</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~getServerIpAddress">getServerIpAddress</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~isInAnyArray">isInAnyArray</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~isObjectEmpty">isObjectEmpty</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~isPromise">isPromise</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~isSimpleObject">isSimpleObject</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~makeSafeForFormInput">makeSafeForFormInput</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~mergeArraysDedupe">mergeArraysDedupe</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~mergeArraysKeepDupes">mergeArraysKeepDupes</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~regexEscapeStr">regexEscapeStr</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~shallowCopy">shallowCopy</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~stringArrayToNiceString">stringArrayToNiceString</a></li></ul></li><li><a href="module-helpers_jrhelpersexpress.html">helpers/jrhelpersexpress</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~asyncPasswordAuthenticate">asyncPasswordAuthenticate</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~asyncPasswordReqLogin">asyncPasswordReqLogin</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~calcExpressMiddleWare">calcExpressMiddleWare</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~calcExpressRoutePathData">calcExpressRoutePathData</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~calcExpressRoutePathDataRouteArray">calcExpressRoutePathDataRouteArray</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~calcExpressRoutePathDataSplit">calcExpressRoutePathDataSplit</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~forgetSessionVar">forgetSessionVar</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~normalizePort">normalizePort</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~reqPrefixedValueArray">reqPrefixedValueArray</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~reqVal">reqVal</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~reqValAsInt">reqValAsInt</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~reqValFromList">reqValFromList</a></li></ul></li><li><a href="module-helpers_jrhelpersmdb.html">helpers/jrhelpersmdb</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrhelpersmdb.html#~calcDatabaseResourceUse">calcDatabaseResourceUse</a></li><li data-type='method'><a href="module-helpers_jrhelpersmdb.html#~calcDatabaseStructure">calcDatabaseStructure</a></li><li data-type='method'><a href="module-helpers_jrhelpersmdb.html#~isValidMongooseObjectId">isValidMongooseObjectId</a></li><li data-type='method'><a href="module-helpers_jrhelpersmdb.html#~mongoIdEqual">mongoIdEqual</a></li></ul></li><li><a href="module-helpers_jrhgrid.html">helpers/jrhgrid</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrhgrid.html#~calcHeaderKeysNicely">calcHeaderKeysNicely</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridList">jrGridList</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridListPager">jrGridListPager</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridListPagerItem">jrGridListPagerItem</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridListPagerItemPerPage">jrGridListPagerItemPerPage</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridListTable">jrGridListTable</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridListTableData">jrGridListTableData</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridListTableHeader">jrGridListTableHeader</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridListTableHeaderSortDir">jrGridListTableHeaderSortDir</a></li></ul></li><li><a href="module-helpers_jrhmisc.html">helpers/jrhmisc</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrBootstrapCollapseBox">jrBootstrapCollapseBox</a></li><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrHtmlFormInputPassword">jrHtmlFormInputPassword</a></li><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrHtmlFormOptionList">jrHtmlFormOptionList</a></li><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrHtmlFormOptionListSelect">jrHtmlFormOptionListSelect</a></li><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrHtmlNiceOptionFromList">jrHtmlNiceOptionFromList</a></li><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrHtmlStrigifyObject">jrHtmlStrigifyObject</a></li><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrPluralize">jrPluralize</a></li><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrPluralizeCount">jrPluralizeCount</a></li></ul></li><li><a href="module-helpers_jrvalidators.html">helpers/jrvalidators</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrvalidators.html#~validateInteger">validateInteger</a></li><li data-type='method'><a href="module-helpers_jrvalidators.html#~validateIntegerRange">validateIntegerRange</a></li><li data-type='method'><a href="module-helpers_jrvalidators.html#~validateRealName">validateRealName</a></li><li data-type='method'><a href="module-helpers_jrvalidators.html#~validateString">validateString</a></li><li data-type='method'><a href="module-helpers_jrvalidators.html#~validateTrueFalse">validateTrueFalse</a></li></ul></li><li><a href="module-routes_api.html">routes/api</a><ul class='methods'><li data-type='method'><a href="module-routes_api.html#~makeSecureTokenAccess">makeSecureTokenAccess</a></li><li data-type='method'><a href="module-routes_api.html#~makeSecureTokenAccessFromRefreshToken">makeSecureTokenAccessFromRefreshToken</a></li><li data-type='method'><a href="module-routes_api.html#~makeSecureTokenRefresh">makeSecureTokenRefresh</a></li><li data-type='method'><a href="module-routes_api.html#~routerAllTokentest">routerAllTokentest</a></li><li data-type='method'><a href="module-routes_api.html#~routerGetIndex">routerGetIndex</a></li><li data-type='method'><a href="module-routes_api.html#~routerGetRefreshaccess">routerGetRefreshaccess</a></li><li data-type='method'><a href="module-routes_api.html#~routerGetReqrefresh">routerGetReqrefresh</a></li><li data-type='method'><a href="module-routes_api.html#~routerGetWildcard">routerGetWildcard</a></li><li data-type='method'><a href="module-routes_api.html#~routerPostReqrefresh">routerPostReqrefresh</a></li><li data-type='method'><a href="module-routes_api.html#~setupRouter">setupRouter</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">helpers/jrhelpersexpress.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module helpers/jrhelpersexpress
 * @author jesse reichler &lt;mouser@donationcoder.com>
 * @copyright 11/2/19

 * @description
 * Collection of helper functions for use with the nodejs express web framework
*/

"use strict";


// modules
const passport = require("passport");

// our helper modules
const JrResult = require("../helpers/jrresult");








//---------------------------------------------------------------------------
/**
 * Async Wrapper around the express/passport passport.authenticate function
 *
 * The passport library uses callbacks instead of promises and aync functions, so we wrap it here in a function that let's us use it like an async function for ease of use.
 * @see &lt;a href="https://github.com/jaredhanson/passport/issues/605">passport docs&lt;/a>
 *
 * @param {*} authOptions
 * @param {*} provider
 * @param {*} providerNiceLabel
 * @param {*} req
 * @param {*} res
 * @param {*} next
 * @param {*} jrResult - our JrResult class with info about success or errors; pass in a valid instance and it is updated
 * @returns a simple object with passport user data
 */
async function asyncPasswordAuthenticate(authOptions, provider, providerNiceLabel, req, res, next, jrResult) {
	// first we make a promise out of passport.authenticate then await on it

	var userPassport;

	// create promise wrapper around passport.authenticate
	const passportPromiseAuth = (ireq, ires, inext) => new Promise((resolve, reject) => {
		passport.authenticate(provider, authOptions, async (err, inuserPassport, info) => {
			if (err || !inuserPassport) {
				// add error
				jrResult.pushError("error authenticating " + providerNiceLabel + ": " + JrResult.passportErrorAsString(info) + ".");
				// run next on error in chain
				if (false &amp;&amp; err) {
					inext(err);
				}
				resolve(jrResult);
			}
			// success
			userPassport = inuserPassport;
			// success resolve
			resolve(jrResult);
		})(ireq, ires, inext);
	});


	// wait for promise resolution
	try {
		// now wait for the passport authenticate promise to run; note there is no case where it rejects; we could do this differently and catch an error
		await passportPromiseAuth(req, res, next);
	} catch (err) {
		// unexpected error
		jrResult.pushError(err.message);
	}

	// return userPassport data object
	return userPassport;
}
//---------------------------------------------------------------------------



//---------------------------------------------------------------------------
// ASYNC wrapper around passport req.login
/**
 * Async Wrapper around the express req.logIn function
 *
 * The express library uses callbacks instead of promises and aync functions, so we wrap it here in a function that let's us use it like an async function for ease of use.
 * @see &lt;a href="https://github.com/jaredhanson/passport/issues/605">passport docs&lt;/a>
 *
 * @param {*} userPassport - simple object with user data to log in the user
 * @param {*} errorMessage - text of errror message added to jrResult on error
 * @param {*} req - express request
 * @param {*} jrResult - our JrResult class with info about success or errors; pass in a valid instance and it is updated
 */
async function asyncPasswordReqLogin(userPassport, errorMessage, req, jrResult) {
	// first we make a promise out of req.logIn then await on it

	// again create promise for passport req.login
	const passportPromiseReqLogin = (ireq) => new Promise((resolve, reject) => {
		// actually login the user
		ireq.logIn(userPassport, async (ierr) => {
			if (ierr) {
				// error (exception) logging them in
				jrResult.pushError(errorMessage + ": " + JrResult.passportErrorAsString(ierr));
				resolve(jrResult);
			}
			// success
			// success resolve
			resolve(jrResult);
		})(ireq);
	});

	try {
		// now wait for the passport req login promise to run; note there is no case where it rejects; we could do this differently and catch an error
		await passportPromiseReqLogin(req);
	} catch (err) {
		// unexpected error
		jrResult.pushError(err.message);
	}
}
//---------------------------------------------------------------------------









//---------------------------------------------------------------------------
/**
 * Suggested code from express builder sample applications; used when creating server and binding it to ip+port
 *
 * @param {*} portval
 * @returns port value (possibly provided as string), converted to an integer if possible
 */
function normalizePort(portval) {
	var port = parseInt(portval, 10);
	if (Number.isNaN(port)) {
		// named pipe
		return portval;
	}
	if (port >= 0) {
		// port number
		return port;
	}
	return false;
}
//---------------------------------------------------------------------------




//---------------------------------------------------------------------------
/**
 * Helper debug function that generates a list (object) of express middleware for display
 * @see &lt;a href="https://github.com/yshing/express-list-middleware/blob/master/index.js">github code&lt;/a>
 * @see &lt;a href="https://github.com/yshing/express-repl-toolkit/tree/master/tools">github code&lt;/a>
 * ##### Notes
 *  * Uses an interesting trick to get file and line number where the middleware is located
 *
 * @param {object} app - the express app object
 * @returns object containing all middleware, suitable for json stringifcation to console, etc.
 */
function calcExpressMiddleWare(app) {
	var appStack = app._router.stack;
	return Array.prototype.map.call(appStack, (middleware, index) => {
		return index + ". " + (middleware.handle.name || "&lt;anonymous function>") + " " + getFileLine(middleware.handle);
	});
	// force the middleware to produce an error to locate the file.
	function getFileLine(handler) {
		try {
			handler(undefined);
		} catch (e) {
			return e.stack.split("\n")[1];
		}
		return null;
	}
}


/**
 * Helper debug function the generates a list (object) of all paths registered to the express app
 *
 * @param {object} expressApp
 * @returns object containing all routes (and whether they are get|post|all)
 */
function calcExpressRoutePathData(expressApp) {
	var siteRoutes = expressApp._router.stack;

	var routes = [];
	siteRoutes.forEach(calcExpressRoutePathDataRouteArray.bind(this, routes, []));
	return routes;
}
//---------------------------------------------------------------------------










//---------------------------------------------------------------------------
/**
 * Internal helper debug function the helps to generate a list (object) of all paths registered to the express app
 * @private
 * @param {*} routes
 * @param {*} routepath
 * @param {*} layer
 */
function calcExpressRoutePathDataRouteArray(routes, routepath, layer) {
	if (layer.route) {
		layer.route.stack.forEach(calcExpressRoutePathDataRouteArray.bind(this, routes, routepath.concat(calcExpressRoutePathDataSplit(layer.route.path))));
	} else if (layer.name === "router" &amp;&amp; layer.handle.stack) {
		routes.push("");
		layer.handle.stack.forEach(calcExpressRoutePathDataRouteArray.bind(this, routes, routepath.concat(calcExpressRoutePathDataSplit(layer.regexp))));
	} else if (layer.method) {
		var pathstr = layer.method.toUpperCase() + " /" + routepath.concat(calcExpressRoutePathDataSplit(layer.regexp)).filter(Boolean).join("/");
		routes.push(pathstr);
	}
}


/**
 * Internal helper debug function the helps to generate a list (object) of all paths registered to the express app.
 * Splits on path separator.
 * @private
 * @see &lt;a href="https://github.com/expressjs/express/issues/3308">github code&lt;/a>
 *
 * @param {*} thing
 * @returns split of path
 */
function calcExpressRoutePathDataSplit(thing) {
	if (typeof thing === "string") {
		return thing.split("/");
	}
	if (thing.fast_slash) {
		return "";
	}
	var match = thing.toString().replace("\\/?", "").replace("(?=\\/|$)", "$").match(/^\/\^((?:\\[.*+?^${}()|[\]\\/]|[^.*+?^${}()|[\]\\/])*)\$\//);
	return match ? match[1].replace(/\\(.)/g, "$1").split("/") : "&lt;complex:" + thing.toString() + ">";
}
//---------------------------------------------------------------------------





/**
 * Express helper function to look for property in request BODY or QUERY and return it, or defaultVal if not present
 *
 * @param {object} req - express request object
 * @param {string} key - key to look for in request body or query
 * @param {*} defaultVal - to return if key not found in request
 * @returns req.body[key] or req.query[key] or defaultVal
 */
function reqVal(req, key, defaultVal) {
	// return query param or post val or default
	if (req.body[key] !== undefined &amp;&amp; req.body[key] !== null) {
		return req.body[key];
	}
	if (req.query[key] !== undefined &amp;&amp; req.query[key] !== null) {
		return req.query[key];
	}
	return defaultVal;
}


/**
 * Express helper to look for property in request BODY or QUERY and return it, or defaultVal if not present
 *
 * @param {object} req - express request object
 * @param {string} key - key to look for in request body or query
 * @param {int} min - min int to floor the value to
 * @param {int} max - max int to ceil the value to
 * @param {int} defaultVal - to return if key not found in request
 * @returns req.body[key] or req.query[key] cast to int in range [min,max] or defaultVal
 */
function reqValAsInt(req, key, min, max, defaultVal) {
	// get val as int and min and max it
	var val = Number(reqVal(req, key, defaultVal));
	if (min !== null) {
		val = Math.max(val, min);
	}
	if (max !== null) {
		val = Math.min(val, max);
	}
	return val;
}


/**
 * Express helper to look for property in request BODY or QUERY and return it, or defaultVal if not present
 *
 * @param {object} req - express request object
 * @param {string} key - key to look for in request body or query
 * @param {array} valueList - list of values that are acceptable
 * @param {*} defaultVal - to return if key not found in request
 * @returns req.body[key] or req.query[key] as long as they are present in valueList, otherwise defaultVal
 */
function reqValFromList(req, key, valueList, defaultVal) {
	var val = reqVal(req, key, defaultVal);
	if (valueList.indexOf(val) > -1) {
		return val;
	}
	return defaultVal;
}


/**
 * Express helper to look for all properties with a given prefix
 *
 * @param {*} req - express request object
 * @param {string} prefix - the prefix string
 * @param {*} keyList
 * @returns an associative array of all key=>value pairs of request properties where key starts with "prefix_key" and key is in keyList
 */
function reqPrefixedValueArray(req, prefix, keyList) {
	// look for ALL values for prefix+"_"+key and return an associative array of them
	var valArray = {};
	var fieldName;
	var val;
	keyList.forEach((key) => {
		fieldName = prefix + "_" + key;
		val = reqVal(req, fieldName, undefined);
		if (val !== undefined &amp;&amp; val !== "") {
			// store it
			valArray[key] = val;
		}
	});

	return valArray;
}


/**
 * Deletes the varname from session data
 *
 * @param {obj} req
 * @param {string} varName
 */
function forgetSessionVar(req, varName) {
	if (req.session &amp;&amp; req.session[varName] !== undefined) {
		delete req.session[varName];
	}
}
//---------------------------------------------------------------------------














// export the class as the sole export
module.exports = {
	asyncPasswordAuthenticate,
	asyncPasswordReqLogin,

	normalizePort,

	calcExpressMiddleWare,
	calcExpressRoutePathData,

	reqVal,
	reqValAsInt,
	reqValFromList,
	reqPrefixedValueArray,
	forgetSessionVar,
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Wed Nov 13 2019 06:59:20 GMT-0600 (Central Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
