<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>helpers/jrhelpers.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-controllers_aclaid-AclAid.html">AclAid</a></li></ul><h3>Modules</h3><ul><li><a href="module-controllers_aclaid.html">controllers/aclaid</a></li><li><a href="module-helpers_jrcrypto.html">helpers/jrcrypto</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrcrypto.html#~createHashedObjectFromString">createHashedObjectFromString</a></li><li data-type='method'><a href="module-helpers_jrcrypto.html#~generateRandomSalt">generateRandomSalt</a></li><li data-type='method'><a href="module-helpers_jrcrypto.html#~genRandomStringHex">genRandomStringHex</a></li><li data-type='method'><a href="module-helpers_jrcrypto.html#~genRandomStringHumanEasier">genRandomStringHumanEasier</a></li><li data-type='method'><a href="module-helpers_jrcrypto.html#~genRandomStringHumanEasy">genRandomStringHumanEasy</a></li><li data-type='method'><a href="module-helpers_jrcrypto.html#~hashPlaintextPasswordToObj">hashPlaintextPasswordToObj</a></li><li data-type='method'><a href="module-helpers_jrcrypto.html#~hashPlaintextStringInsecureButSearchable">hashPlaintextStringInsecureButSearchable</a></li><li data-type='method'><a href="module-helpers_jrcrypto.html#~testPlaintextPassword">testPlaintextPassword</a></li></ul></li><li><a href="module-helpers_jrhandlebars.html">helpers/jrhandlebars</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrhandlebars.html#~loadPartialFiles">loadPartialFiles</a></li><li data-type='method'><a href="module-helpers_jrhandlebars.html#~setupJrHandlebarHelpers">setupJrHandlebarHelpers</a></li></ul></li><li><a href="module-helpers_jrhelpers.html">helpers/jrhelpers</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrhelpers.html#~asyncAwaitForEachFunctionCall">asyncAwaitForEachFunctionCall</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~createObjectFromJsonParse">createObjectFromJsonParse</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~DateNowPlusMinutes">DateNowPlusMinutes</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~deepIterationCopy">deepIterationCopy</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~firstCoercedTrueValue">firstCoercedTrueValue</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~getNiceNowString">getNiceNowString</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~getNonFalseValueOrDefault">getNonFalseValueOrDefault</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~getPreciseNowString">getPreciseNowString</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~getServerIpAddress">getServerIpAddress</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~isInAnyArray">isInAnyArray</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~isObjectEmpty">isObjectEmpty</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~isPromise">isPromise</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~isSimpleObject">isSimpleObject</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~makeSafeForFormInput">makeSafeForFormInput</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~mergeArraysDedupe">mergeArraysDedupe</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~mergeArraysKeepDupes">mergeArraysKeepDupes</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~regexEscapeStr">regexEscapeStr</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~shallowCopy">shallowCopy</a></li><li data-type='method'><a href="module-helpers_jrhelpers.html#~stringArrayToNiceString">stringArrayToNiceString</a></li></ul></li><li><a href="module-helpers_jrhelpersexpress.html">helpers/jrhelpersexpress</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~asyncPasswordAuthenticate">asyncPasswordAuthenticate</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~asyncPasswordReqLogin">asyncPasswordReqLogin</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~calcExpressMiddleWare">calcExpressMiddleWare</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~calcExpressRoutePathData">calcExpressRoutePathData</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~calcExpressRoutePathDataRouteArray">calcExpressRoutePathDataRouteArray</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~calcExpressRoutePathDataSplit">calcExpressRoutePathDataSplit</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~forgetSessionVar">forgetSessionVar</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~normalizePort">normalizePort</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~reqPrefixedValueArray">reqPrefixedValueArray</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~reqVal">reqVal</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~reqValAsInt">reqValAsInt</a></li><li data-type='method'><a href="module-helpers_jrhelpersexpress.html#~reqValFromList">reqValFromList</a></li></ul></li><li><a href="module-helpers_jrhelpersmdb.html">helpers/jrhelpersmdb</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrhelpersmdb.html#~calcDatabaseResourceUse">calcDatabaseResourceUse</a></li><li data-type='method'><a href="module-helpers_jrhelpersmdb.html#~calcDatabaseStructure">calcDatabaseStructure</a></li><li data-type='method'><a href="module-helpers_jrhelpersmdb.html#~isValidMongooseObjectId">isValidMongooseObjectId</a></li><li data-type='method'><a href="module-helpers_jrhelpersmdb.html#~mongoIdEqual">mongoIdEqual</a></li></ul></li><li><a href="module-helpers_jrhgrid.html">helpers/jrhgrid</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrhgrid.html#~calcHeaderKeysNicely">calcHeaderKeysNicely</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridList">jrGridList</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridListPager">jrGridListPager</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridListPagerItem">jrGridListPagerItem</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridListPagerItemPerPage">jrGridListPagerItemPerPage</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridListTable">jrGridListTable</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridListTableData">jrGridListTableData</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridListTableHeader">jrGridListTableHeader</a></li><li data-type='method'><a href="module-helpers_jrhgrid.html#~jrGridListTableHeaderSortDir">jrGridListTableHeaderSortDir</a></li></ul></li><li><a href="module-helpers_jrhmisc.html">helpers/jrhmisc</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrBootstrapCollapseBox">jrBootstrapCollapseBox</a></li><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrHtmlFormInputPassword">jrHtmlFormInputPassword</a></li><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrHtmlFormOptionList">jrHtmlFormOptionList</a></li><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrHtmlFormOptionListSelect">jrHtmlFormOptionListSelect</a></li><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrHtmlNiceOptionFromList">jrHtmlNiceOptionFromList</a></li><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrHtmlStrigifyObject">jrHtmlStrigifyObject</a></li><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrPluralize">jrPluralize</a></li><li data-type='method'><a href="module-helpers_jrhmisc.html#~jrPluralizeCount">jrPluralizeCount</a></li></ul></li><li><a href="module-helpers_jrvalidators.html">helpers/jrvalidators</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrvalidators.html#~validateInteger">validateInteger</a></li><li data-type='method'><a href="module-helpers_jrvalidators.html#~validateIntegerRange">validateIntegerRange</a></li><li data-type='method'><a href="module-helpers_jrvalidators.html#~validateRealName">validateRealName</a></li><li data-type='method'><a href="module-helpers_jrvalidators.html#~validateString">validateString</a></li><li data-type='method'><a href="module-helpers_jrvalidators.html#~validateTrueFalse">validateTrueFalse</a></li></ul></li><li><a href="module-routes_api.html">routes/api</a><ul class='methods'><li data-type='method'><a href="module-routes_api.html#~makeSecureTokenAccess">makeSecureTokenAccess</a></li><li data-type='method'><a href="module-routes_api.html#~makeSecureTokenAccessFromRefreshToken">makeSecureTokenAccessFromRefreshToken</a></li><li data-type='method'><a href="module-routes_api.html#~makeSecureTokenRefresh">makeSecureTokenRefresh</a></li><li data-type='method'><a href="module-routes_api.html#~routerAllTokentest">routerAllTokentest</a></li><li data-type='method'><a href="module-routes_api.html#~routerGetIndex">routerGetIndex</a></li><li data-type='method'><a href="module-routes_api.html#~routerGetRefreshaccess">routerGetRefreshaccess</a></li><li data-type='method'><a href="module-routes_api.html#~routerGetReqrefresh">routerGetReqrefresh</a></li><li data-type='method'><a href="module-routes_api.html#~routerGetWildcard">routerGetWildcard</a></li><li data-type='method'><a href="module-routes_api.html#~routerPostReqrefresh">routerPostReqrefresh</a></li><li data-type='method'><a href="module-routes_api.html#~setupRouter">setupRouter</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">helpers/jrhelpers.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module helpers/jrhelpers
 * @author jesse reichler &lt;mouser@donationcoder.com>
 * @copyright 5/7/19

 * @description
 * Collection of my general purpose helper functions that could be used in various projects.
*/

"use strict";





//---------------------------------------------------------------------------
// helper function for merging unique arrays
// see https://stackoverflow.com/questions/1584370/how-to-merge-two-arrays-in-javascript-and-de-duplicate-items
/**
 * Combine two arrays and return the concatenation; duplicates are *not* removed
 *
 * @param {array} array1
 * @param {array} array2
 * @returns concatenated array
 */
function mergeArraysKeepDupes(array1, array2) {
	return array1.concat(array2);
}

/**
 * Combine two arrays and return the combined array, removing all duplicates
 *
 * @param {array} array1
 * @param {array} array2
 * @returns the combined de-duped array
 */
function mergeArraysDedupe(array1, array2) {
	return Array.from(new Set(array1.concat(array2)));
}

/**
 * Check if a value is present in any arrays
 *
 * @param {*} val
 * @param {array} arrays (1 or more arrays passed as variadic arguements)
 * @returns true if val is found in any of the arrays
 */
function isInAnyArray(val, ...arrays) {
	for (var ar of arrays) {
		if (ar &amp;&amp; ar.indexOf(val) !== -1) {
			return true;
		}
	}
	return false;
}
//---------------------------------------------------------------------------



//---------------------------------------------------------------------------
/**
 * Take an iteratble (array) of objects and a function to call on each, and do an await function on each.
 * @example asyncAwaitForEachFunctionCall([1 2 3], (x) => {console.log(x)})
 *
 * @param {array} array
 * @param {function} func
 */
async function asyncAwaitForEachFunctionCall(array, func) {
	for (let index = 0; index &lt; array.length; index++) {
		await func(array[index], index, array);
	}
}
//---------------------------------------------------------------------------



//---------------------------------------------------------------------------
/**
 * If val evaluates to false (which will happen on values of null, undefined, false, and ""), return defaultVal, otherwise return val.
 * ##### Notes
 *  * The intention of this function is to be used to check if a value was provided for some option, and use a default if not.
 *  * This can be confusing if the false value is passed in and caller expects to get it back instead of the defaultVal
 *  * In previous version we explicitly tested val against null, undefined, and ""
 *  * The main reason to use a function for this instead of just using a line in code testing truthiness of val, is to help us locate these kind of tests in code via a search, since they are prone to issues.
 *
 * @param {*} val
 * @param {*} defaultVal
 * @returns val [if it evaluates to true] else defaultVal
 */
function getNonFalseValueOrDefault(val, defaultVal) {
	if (!val) {
		return defaultVal;
	}
	return val;
}


/**
 * Accepts a variadic list of arguments and returns the first one that can be coerced to true.
 *
 * @param {*} args - variadic list of arguments
 * @returns the first arg that evaluates to true (e.g. not null, undefined, false, ""); if none found returns undefined
 */
function firstCoercedTrueValue(...args) {
	if (!args || args.length === 0) {
		return undefined;
	}
	for (var arg of args) {
		if (arg) {
			return arg;
		}
	}
	// none found
	return undefined;
}



/**
 * Checks if the passed argument is an empty object/array/list by checking its length
 *
 * @param {*} obj - an array, object, or iterable with length property, OR an undefined/null valued variable
 * @returns true if the passed obj evaluates to false (null, undefined, "", false) OR is an object/array with no properties.
 * @see &lt;a href="https://stackoverflow.com/questions/679915/how-do-i-test-for-an-empty-javascript-object">stackoverflow question on testing for empty objects&lt;/a>
 */
function isObjectEmpty(obj) {
	if (!obj || (Object.entries(obj).length === 0 &amp;&amp; obj.constructor === Object)) {
		return true;
	}
	if (!obj || Object.keys(obj).length === 0) {
		return true;
	}
	return false;
}
//---------------------------------------------------------------------------




//---------------------------------------------------------------------------
/**
 * return a new Date() whose date is a certain number of minutes in the future; useful for setting expiration times
 *
 * @param {int} expirationMinutes
 * @returns Date
 */
function DateNowPlusMinutes(expirationMinutes) {
	var expirationDate = new Date();
	expirationDate.setMinutes(expirationDate.getMinutes() + expirationMinutes);
	return expirationDate;
}
//---------------------------------------------------------------------------







//---------------------------------------------------------------------------
/**
 * Copies an objects properties, in a shallow fashion (nested objects/arrays reuse the references)
 * ##### Notes
 *  * This is not a deep copy, it will reuse any sub object/array properties
 *  * We use a function instead of one-line of code to make it easier to find places in code where this happens
 *  * See &lt;a href="https://medium.com/better-programming/3-ways-to-clone-objects-in-javascript-f752d148054d">Medium.com post on different ways to copy objects&lt;/a>
 *
 * @param {object} source
 * @returns new object with cloned properties
 */
function shallowCopy(source) {
	// just a simple wrapper to make code easier to understand
	// var obj = Object.assign({}, source);
	var obj = { ...source };
	return obj;
}



/**
 * Performs a deep copy of an object, recursing into sub properties to clone them instead of reuse references
 * ##### Notes
 * See &lt;a href="https://medium.com/better-programming/3-ways-to-clone-objects-in-javascript-f752d148054d">Medium.com post on different ways to copy objects&lt;/a>
 * @param {*} src
 * @returns new object deep copy of the source
 */
function deepIterationCopy(src) {
	var target = {};
	for (var prop in src) {
		if (Object.prototype.hasOwnProperty.call(src, prop)) {
			if (isSimpleObject(src[prop])) {
				// it's a nested property
				target[prop] = deepIterationCopy(src[prop]);
			} else {
				target[prop] = src[prop];
			}
		}
	}
	return target;
}
//---------------------------------------------------------------------------


//---------------------------------------------------------------------------
/**
 * Simple wrapper arround array.toString that returns blank string if passed value is null, undefined, or empty
 *
 * @param {array} arr - an array or null or undefined
 * @returns arr.toString() if there are items in the array, otherwise empty string ""
 */
function stringArrayToNiceString(arr) {
	if (!arr || arr.length === 0) {
		return "";
	}
	return arr.toString();
}


/**
 * Return current date as a string in a nice format, in local time zone
 * @returns current date as string
 */
function getNiceNowString() {
	return new Date(Date.now()).toLocaleString();
}


/**
 * Return the current date in a standardized string format with precise timing; suitable for timestampign to seconds accuracy
 * @returns current date and time as string with seconds precision
 */
function getPreciseNowString() {
	return new Date(Date.now()).toISOString();
}
//---------------------------------------------------------------------------








//---------------------------------------------------------------------------
/**
 * Replace special characters in string so it can be used in regex.
 * This is useful when we want to use a user-provided string in a regular expression and so we need to validate/escape it first.
 * It is used in our admin crud area filters to convert a simple user substring into a wildcard search string
 * ##### TODO
 *  * check this for any security vulnerabilities
 *
 * @param {string} str
 * @returns escaped version of string suitable for use inside a regular expression (i.e. no unescaped regex characters)
 */
function regexEscapeStr(str) {
	str = str.replace(/[-/\\^$*+?.()|[\]{}]/g, "\\$&amp;");
	return str;
}

/**
 * Escape any characters or remove them, that would be illegal to have inside a form input value
 * ##### Notes
 *  * Replaces double quote characters with &amp;quot;
 *
 * @param {string} str
 * @returns version of string with double quotes replaced, etc.
 */
function makeSafeForFormInput(str) {
	return str.replace(/"/g, "&amp;quot;");
}
//---------------------------------------------------------------------------




//---------------------------------------------------------------------------
/**
 * Returns true if the passed value is derived from the Object class/constructor.
 * ##### Notes
 *  * This will return false for object that are more elaborate classes, and is only meant to be used for doing deep copies of simple {} objects
 *  * This will return false if the passed value is null or undefined
 *  * This will return false if the passed object is a function (unlike the code it was based on)
 *  * see &lt;a href="https://stackoverflow.com/questions/8511281/check-if-a-value-is-an-object-in-javascript">stackoverflow on checking if a value is an object&lt;/a>
 *
 * @param {*} maybeObj
 * @returns true if the passed value is a (simple) object
 */
function isSimpleObject(maybeObj) {
	// return (maybeObj !== undefined &amp;&amp; maybeObj !== null &amp;&amp; maybeObj.constructor === Object);
	var type = typeof maybeObj;
	return type === "object" &amp;&amp; !!maybeObj;
}


/**
 * Returns true if the object passed is a promise
 * @see &lt;a href="https://stackoverflow.com/questions/27746304/how-do-i-tell-if-an-object-is-a-promise">stackoverflow post&lt;/a>
 *
 * @param {*} value
 * @returns true if the passed value is a promise
 */
function isPromise(value) {
	return Boolean(value &amp;&amp; typeof value.then === "function");
}
//---------------------------------------------------------------------------




//---------------------------------------------------------------------------
/**
 * Simple wrapper around JSON.parse, which parses a json string and creates an object.
 * Only thing extra we do is check for being passed in an empty string/null/undefined and return {} in that case
 *
 * @param {string} str
 * @param {*} defaultVal
 * @returns result of JSON.parse on string or {} if string is "" or undefined or null
 */
function createObjectFromJsonParse(str, defaultVal) {
	if (!str) {
		return defaultVal;
	}
	var parsedObj = JSON.parse(str);
	return parsedObj;
}
//---------------------------------------------------------------------------



//---------------------------------------------------------------------------
/**
 * Try to figure out the servers ip address, and return it as a string.
 * ##### Notes
 *  * see &lt;a href="https://stackoverflow.com/questions/3653065/get-local-ip-address-in-node-js">stackoverflow post&lt;/a>
 *  * This function has barely been tested and should not be considered reliable.
 *  * We are currently using it only to get a string that we can use to look for a site-specific configuration file based on the current server ip, and just to display on screen and in logs.
 *  * So our goal is simply to return a string that is different on different servers, but always the same on a given server
 *  * You cannot assume that the returned value is of a particular format; we dont check for that.
 * @returns string representation of ip address
 */
function getServerIpAddress() {
	var os = require("os");

	var ifaces = os.networkInterfaces();
	var ifacesKeys = Object.keys(ifaces);
	var iface, ifname, ifaceset;
	var bestip;
	var alias = 0;

	// jrlog.debugObj(ifaces, "ifaces");
	// jrlog.debugObj(ifacesKeys, "ifacesKeys");

	for (var j = 0; j &lt; ifacesKeys.length; ++j) {
		ifname = ifacesKeys[j];

		ifaceset = ifaces[ifname];
		// jrlog.debugObj(ifaceset, "ifaceset");

		alias = 0;
		for (var i = 0; i &lt; ifaceset.length; ++i) {
			iface = ifaceset[i];
			// jrlog.debugObj(iface, "iface[" + ifname + "]");
			if (iface.family !== "IPv4" || iface.internal !== false) {
				// skip over internal (i.e. 127.0.0.1) and non-ipv4 addresses
				bestip = iface.address;
			} else if (alias >= 1) {
				// this single interface has multiple ipv4 addresses
				bestip = iface.address;
				break;
			} else {
				// this interface has only one ipv4 adress
				bestip = iface.address;
				break;
			}
			++alias;
		}
		if (bestip) {
			return bestip;
		}
	}
	// not found;
	return "";
}
//---------------------------------------------------------------------------








module.exports = {
	mergeArraysKeepDupes,
	mergeArraysDedupe,
	isInAnyArray,

	asyncAwaitForEachFunctionCall,

	getNonFalseValueOrDefault,
	firstCoercedTrueValue,
	isObjectEmpty,

	DateNowPlusMinutes,

	shallowCopy,
	deepIterationCopy,

	stringArrayToNiceString,
	getNiceNowString,
	getPreciseNowString,

	regexEscapeStr,
	makeSafeForFormInput,

	isSimpleObject,
	isPromise,
	createObjectFromJsonParse,

	getServerIpAddress,

};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Wed Nov 13 2019 06:59:20 GMT-0600 (Central Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
