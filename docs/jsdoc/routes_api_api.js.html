<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>routes/api/api.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="JrResult.JrContext.html">JrContext</a></li><li><a href="JrResult.JrResult.html">JrResult</a></li><li><a href="module-client_arclient-AppRoomClient.html">AppRoomClient</a></li><li><a href="module-controllers_aclaid-AclAid.html">AclAid</a></li><li><a href="module-controllers_adminaid-AdminAid.html">AdminAid</a></li><li><a href="module-controllers_arserver-AppRoomServer.html">AppRoomServer</a><ul class='methods'><li data-type='method'><a href="module-controllers_arserver-AppRoomServer.html#emergencyAlert">emergencyAlert</a></li><li data-type='method'><a href="module-controllers_arserver-AppRoomServer.html#makeSecureTokenAccess">makeSecureTokenAccess</a></li><li data-type='method'><a href="module-controllers_arserver-AppRoomServer.html#makeSecureTokenAccessFromRefreshToken">makeSecureTokenAccessFromRefreshToken</a></li><li data-type='method'><a href="module-controllers_arserver-AppRoomServer.html#makeSecureTokenRefresh">makeSecureTokenRefresh</a></li></ul></li><li><a href="module-controllers_crudaid-CrudAid.html">CrudAid</a></li><li><a href="module-controllers_registrationaid-RegistrationAid.html">RegistrationAid</a></li><li><a href="module-controllers_sendaid-SendAid.html">SendAid</a><ul class='methods'><li data-type='method'><a href="module-controllers_sendaid-SendAid.html#sendMail">sendMail</a></li><li data-type='method'><a href="module-controllers_sendaid-SendAid.html#sendMessage">sendMessage</a></li></ul></li><li><a href="module-controllers_setupaid-SetupAid.html">SetupAid</a></li><li><a href="module-helpers_jrresult-JrResult.html">JrResult</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#._unusedCodeExpressMiddlewareInjectSessionResult">_unusedCodeExpressMiddlewareInjectSessionResult</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#.isBlank">isBlank</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#.isJrResult">isJrResult</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#.makeClone">makeClone</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#.makeError">makeError</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#.makeMessage">makeMessage</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#.makeNew">makeNew</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#.makeSuccess">makeSuccess</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#.passportOrJrResultErrorAsString">passportOrJrResultErrorAsString</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#.retrieveThenRemoveFromSession">retrieveThenRemoveFromSession</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#.undefinedIfBlank">undefinedIfBlank</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#addToSession">addToSession</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#clear">clear</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#clearSection">clearSection</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#copyFrom">copyFrom</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#getErrorsAsString">getErrorsAsString</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#getExtraData">getExtraData</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#getFieldError">getFieldError</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#getSuccessAsString">getSuccessAsString</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#getType">getType</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#isError">isError</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#mergeIn">mergeIn</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#mergeInThenRemoveFromSession">mergeInThenRemoveFromSession</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#push">push</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#pushBiFieldError">pushBiFieldError</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#pushError">pushError</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#pushErrorOnTop">pushErrorOnTop</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#pushException">pushException</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#pushFieldError">pushFieldError</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#pushMessage">pushMessage</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#pushSuccess">pushSuccess</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#setError">setError</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#setExtraData">setExtraData</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#setFieldError">setFieldError</a></li><li data-type='method'><a href="module-helpers_jrresult-JrResult.html#setType">setType</a></li></ul></li><li><a href="module-models_app-AppModel.html">AppModel</a></li><li><a href="module-models_connection-ConnectionModel.html">ConnectionModel</a></li><li><a href="module-models_file-FileModel.html">FileModel</a></li><li><a href="module-models_login-LoginModel.html">LoginModel</a></li><li><a href="module-models_log-LogModel.html">LogModel</a></li><li><a href="module-models_model_base_mongoose_minimal-ModelBaseMongooseMinimal.html">ModelBaseMongooseMinimal</a></li><li><a href="module-models_modelBaseMongoose-ModelBaseMongoose.html">ModelBaseMongoose</a><ul class='methods'><li data-type='method'><a href="module-models_modelBaseMongoose-ModelBaseMongoose.html#.doChangeModeById">doChangeModeById</a></li><li data-type='method'><a href="module-models_modelBaseMongoose-ModelBaseMongoose.html#doChangeMode">doChangeMode</a></li></ul></li><li><a href="module-models_modqueue-ModQueueModel.html">ModQueueModel</a></li><li><a href="module-models_option-OptionModel.html">OptionModel</a></li><li><a href="module-models_option-RoleModel.html">RoleModel</a></li><li><a href="module-models_roomdata-RoomdataModel.html">RoomdataModel</a></li><li><a href="module-models_room-RoomModel.html">RoomModel</a></li><li><a href="module-models_session-SessionModel.html">SessionModel</a></li><li><a href="module-models_subscription-SubscriptionModel.html">SubscriptionModel</a></li><li><a href="module-models_user-UserModel.html">UserModel</a><ul class='methods'><li data-type='method'><a href="module-models_user-UserModel.html#aclHasPermission">aclHasPermission</a></li><li data-type='method'><a href="module-models_user-UserModel.html#aclHasPermissionOnAll">aclHasPermissionOnAll</a></li><li data-type='method'><a href="module-models_user-UserModel.html#aclHasPermissionSeeVDeletes">aclHasPermissionSeeVDeletes</a></li></ul></li><li><a href="module-models_verification-VerificationModel.html">VerificationModel</a></li></ul><h3>Modules</h3><ul><li><a href="module-arglobals.html">arglobals</a><ul class='methods'><li data-type='method'><a href="module-arglobals.html#~setupDefaultModulePaths">setupDefaultModulePaths</a></li></ul></li><li><a href="module-client_arclient.html">client/arclient</a><ul class='methods'><li data-type='method'><a href="module-client_arclient.html#~makeNewAppRoomClient">makeNewAppRoomClient</a></li></ul></li><li><a href="module-clientTests.html">clientTests</a></li><li><a href="module-controllers_aclaid.html">controllers/aclaid</a></li><li><a href="module-controllers_adminaid.html">controllers/adminaid</a></li><li><a href="module-controllers_appdef.html">controllers/appdef</a></li><li><a href="module-controllers_arserver.html">controllers/arserver</a></li><li><a href="module-controllers_crudaid.html">controllers/crudaid</a></li><li><a href="module-controllers_jrequireaid.html">controllers/jrequireaid</a><ul class='methods'><li data-type='method'><a href="module-controllers_jrequireaid.html#~setDeferredLoading">setDeferredLoading</a></li><li data-type='method'><a href="module-controllers_jrequireaid.html#~setupDefaultModulePaths">setupDefaultModulePaths</a></li></ul></li><li><a href="module-controllers_registrationaid.html">controllers/registrationaid</a></li><li><a href="module-controllers_sendaid.html">controllers/sendaid</a></li><li><a href="module-controllers_setupaid.html">controllers/setupaid</a></li><li><a href="module-helpers_jrconfig.html">helpers/jrconfig</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrconfig.html#~addConfigFile">addConfigFile</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~addConfigFilesCli">addConfigFilesCli</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~configAutoConverTypeVal">configAutoConverTypeVal</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~discoverConfigFiles">discoverConfigFiles</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~doNconfFile">doNconfFile</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~findQueuedCommand">findQueuedCommand</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~fixConfigFilePathName">fixConfigFilePathName</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~getDebugFiles">getDebugFiles</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~getDebugHierarchy">getDebugHierarchy</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~getDebugOptions">getDebugOptions</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~getVal">getVal</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~getValDefault">getValDefault</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~ipStringToSafeFilenameString">ipStringToSafeFilenameString</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~nconfMergeConfigFile">nconfMergeConfigFile</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~parse">parse</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~popQueuedCommand">popQueuedCommand</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~queueYargsCommand">queueYargsCommand</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~runQueuedCommands">runQueuedCommands</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~setConfigDirs">setConfigDirs</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~setDefaultOptions">setDefaultOptions</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~setEnvList">setEnvList</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~setOverrideOptions">setOverrideOptions</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~setServerFilenamePrefixFromServerIp">setServerFilenamePrefixFromServerIp</a></li><li data-type='method'><a href="module-helpers_jrconfig.html#~setYargs">setYargs</a></li></ul></li><li><a href="module-helpers_jrcontext.html">helpers/jrcontext</a></li><li><a href="module-helpers_jrdebug.html">helpers/jrdebug</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrdebug.html#~cdebug">cdebug</a></li><li data-type='method'><a href="module-helpers_jrdebug.html#~cdebugf">cdebugf</a></li><li data-type='method'><a href="module-helpers_jrdebug.html#~cdebugObj">cdebugObj</a></li><li data-type='method'><a href="module-helpers_jrdebug.html#~debug">debug</a></li><li data-type='method'><a href="module-helpers_jrdebug.html#~debugf">debugf</a></li><li data-type='method'><a href="module-helpers_jrdebug.html#~debugObj">debugObj</a></li><li data-type='method'><a href="module-helpers_jrdebug.html#~debugObj2">debugObj2</a></li><li data-type='method'><a href="module-helpers_jrdebug.html#~getDebugTagEnabled">getDebugTagEnabled</a></li><li data-type='method'><a href="module-helpers_jrdebug.html#~setDebugTagEnabled">setDebugTagEnabled</a></li><li data-type='method'><a href="module-helpers_jrdebug.html#~setup">setup</a></li><li data-type='method'><a href="module-helpers_jrdebug.html#~setupDebugmod">setupDebugmod</a></li></ul></li><li><a href="module-helpers_jrequire.html">helpers/jrequire</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrequire.html#~calcDebugInfo">calcDebugInfo</a></li><li data-type='method'><a href="module-helpers_jrequire.html#~fixRequirePath">fixRequirePath</a></li><li data-type='method'><a href="module-helpers_jrequire.html#~jrequire">jrequire</a></li><li data-type='method'><a href="module-helpers_jrequire.html#~registerPath">registerPath</a></li><li data-type='method'><a href="module-helpers_jrequire.html#~registerRequire">registerRequire</a></li><li data-type='method'><a href="module-helpers_jrequire.html#~setDeferredLoading">setDeferredLoading</a></li></ul></li><li><a href="module-helpers_jrh_axios.html">helpers/jrh_axios</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrh_axios.html#~calcAxiosOptions">calcAxiosOptions</a></li><li data-type='method'><a href="module-helpers_jrh_axios.html#~getCatchError">getCatchError</a></li><li data-type='method'><a href="module-helpers_jrh_axios.html#~postAxiosGetResponseDataCatchError">postAxiosGetResponseDataCatchError</a></li></ul></li><li><a href="module-helpers_jrh_crypto.html">helpers/jrh_crypto</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrh_crypto.html#~createHashedObjectFromString">createHashedObjectFromString</a></li><li data-type='method'><a href="module-helpers_jrh_crypto.html#~generateRandomSalt">generateRandomSalt</a></li><li data-type='method'><a href="module-helpers_jrh_crypto.html#~genRandomStringFromCharSet">genRandomStringFromCharSet</a></li><li data-type='method'><a href="module-helpers_jrh_crypto.html#~genRandomStringHex">genRandomStringHex</a></li><li data-type='method'><a href="module-helpers_jrh_crypto.html#~genRandomStringHumanEasier">genRandomStringHumanEasier</a></li><li data-type='method'><a href="module-helpers_jrh_crypto.html#~genRandomStringHumanEasy">genRandomStringHumanEasy</a></li><li data-type='method'><a href="module-helpers_jrh_crypto.html#~hashPlaintextPasswordToObj">hashPlaintextPasswordToObj</a></li><li data-type='method'><a href="module-helpers_jrh_crypto.html#~hashPlaintextStringInsecureButSearchable">hashPlaintextStringInsecureButSearchable</a></li><li data-type='method'><a href="module-helpers_jrh_crypto.html#~testPlaintextPassword">testPlaintextPassword</a></li></ul></li><li><a href="module-helpers_jrh_express.html">helpers/jrh_express</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrh_express.html#~asyncPassportAuthenticate">asyncPassportAuthenticate</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~asyncPassportReqLogin">asyncPassportReqLogin</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~calcExpressMiddleWare">calcExpressMiddleWare</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~calcExpressMiddlewareGetFileLine">calcExpressMiddlewareGetFileLine</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~calcExpressMiddlewareRouterHint">calcExpressMiddlewareRouterHint</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~calcExpressRoutePathData">calcExpressRoutePathData</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~calcExpressRoutePathDataRouteArray">calcExpressRoutePathDataRouteArray</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~calcExpressRoutePathDataSplit">calcExpressRoutePathDataSplit</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~forgetSessionVar">forgetSessionVar</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~normalizePort">normalizePort</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~parseReqGetJsonField">parseReqGetJsonField</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~reqOriginalUrl">reqOriginalUrl</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~reqPrefixedCheckboxItemIds">reqPrefixedCheckboxItemIds</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~reqPrefixedValueArray">reqPrefixedValueArray</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~reqUrlWithPath">reqUrlWithPath</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~reqVal">reqVal</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~reqValAsInt">reqValAsInt</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~reqValFromList">reqValFromList</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~sendJsonDataSuccess">sendJsonDataSuccess</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~sendJsonErorrAcl">sendJsonErorrAcl</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~sendJsonError">sendJsonError</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~sendJsonErrorAuthToken">sendJsonErrorAuthToken</a></li><li data-type='method'><a href="module-helpers_jrh_express.html#~sendJsonResult">sendJsonResult</a></li></ul></li><li><a href="module-helpers_jrh_grid.html">helpers/jrh_grid</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrh_grid.html#~calcHeaderKeysNicely">calcHeaderKeysNicely</a></li><li data-type='method'><a href="module-helpers_jrh_grid.html#~jrGridList">jrGridList</a></li><li data-type='method'><a href="module-helpers_jrh_grid.html#~jrGridListBulkActions">jrGridListBulkActions</a></li><li data-type='method'><a href="module-helpers_jrh_grid.html#~jrGridListPager">jrGridListPager</a></li><li data-type='method'><a href="module-helpers_jrh_grid.html#~jrGridListPagerItem">jrGridListPagerItem</a></li><li data-type='method'><a href="module-helpers_jrh_grid.html#~jrGridListPagerItemPerPage">jrGridListPagerItemPerPage</a></li><li data-type='method'><a href="module-helpers_jrh_grid.html#~jrGridListShowHiddenOptions">jrGridListShowHiddenOptions</a></li><li data-type='method'><a href="module-helpers_jrh_grid.html#~jrGridListTable">jrGridListTable</a></li><li data-type='method'><a href="module-helpers_jrh_grid.html#~jrGridListTableData">jrGridListTableData</a></li><li data-type='method'><a href="module-helpers_jrh_grid.html#~jrGridListTableHeader">jrGridListTableHeader</a></li><li data-type='method'><a href="module-helpers_jrh_grid.html#~jrGridListTableHeaderSortDir">jrGridListTableHeaderSortDir</a></li></ul></li><li><a href="module-helpers_jrh_handlebars.html">helpers/jrh_handlebars</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrh_handlebars.html#~loadPartialFiles">loadPartialFiles</a></li><li data-type='method'><a href="module-helpers_jrh_handlebars.html#~setupJrHandlebarHelpers">setupJrHandlebarHelpers</a></li></ul></li><li><a href="module-helpers_jrh_misc.html">helpers/jrh_misc</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrh_misc.html#~asyncAwaitForEachFunctionCall">asyncAwaitForEachFunctionCall</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~asyncAwaitForEachObjectKeyFunctionCall">asyncAwaitForEachObjectKeyFunctionCall</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~asyncNextTick">asyncNextTick</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~copyMissingValues">copyMissingValues</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~createObjectFromJsonParse">createObjectFromJsonParse</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~DateNowPlusMinutes">DateNowPlusMinutes</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~deepIterationCopy">deepIterationCopy</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~ErrorToHashableMapObject">ErrorToHashableMapObject</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~findLongestPrefixAndRemainder">findLongestPrefixAndRemainder</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~firstCoercedTrueValue">firstCoercedTrueValue</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~getCompactNowString">getCompactNowString</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~getNiceDateValString">getNiceDateValString</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~getNiceDurationTimeMs">getNiceDurationTimeMs</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~getNiceNowString">getNiceNowString</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~getNonFalseValueOrDefault">getNonFalseValueOrDefault</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~getNonNullValueFromObject">getNonNullValueFromObject</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~getNonNullValueOrDefault">getNonNullValueOrDefault</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~getPreciseNowString">getPreciseNowString</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~getServerIpAddress">getServerIpAddress</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~isInAnyArray">isInAnyArray</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~isObjectEmpty">isObjectEmpty</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~isObjectHashMappableType">isObjectHashMappableType</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~isPromise">isPromise</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~isSimpleObject">isSimpleObject</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~makeSafeForFormInput">makeSafeForFormInput</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~mergeArraysDedupe">mergeArraysDedupe</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~mergeArraysKeepDupes">mergeArraysKeepDupes</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~objectHasProperty">objectHasProperty</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~objToString">objToString</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~objToString2">objToString2</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~regexEscapeStr">regexEscapeStr</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~resolvePossiblyRelativeDirectory">resolvePossiblyRelativeDirectory</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~shallowCopy">shallowCopy</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~stringArrayToNiceString">stringArrayToNiceString</a></li><li data-type='method'><a href="module-helpers_jrh_misc.html#~usleep">usleep</a></li></ul></li><li><a href="module-helpers_jrh_mongo.html">helpers/jrh_mongo</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrh_mongo.html#~calcDatabaseInfo">calcDatabaseInfo</a></li><li data-type='method'><a href="module-helpers_jrh_mongo.html#~calcDatabaseStructure">calcDatabaseStructure</a></li><li data-type='method'><a href="module-helpers_jrh_mongo.html#~convertArrayOfObjectIdsToIdArray">convertArrayOfObjectIdsToIdArray</a></li><li data-type='method'><a href="module-helpers_jrh_mongo.html#~isValidMongooseObjectId">isValidMongooseObjectId</a></li><li data-type='method'><a href="module-helpers_jrh_mongo.html#~OldUnusedMongoIdEqual">OldUnusedMongoIdEqual</a></li></ul></li><li><a href="module-helpers_jrh_mongo_filter.html">helpers/jrh_mongo_filter</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrh_mongo_filter.html#~buildMongooseQueryFromReq">buildMongooseQueryFromReq</a></li><li data-type='method'><a href="module-helpers_jrh_mongo_filter.html#~convertReqQueryStringToAMongooseFindFilter">convertReqQueryStringToAMongooseFindFilter</a></li><li data-type='method'><a href="module-helpers_jrh_mongo_filter.html#~convertReqQueryStringToAMongooseFindFilterBoolean">convertReqQueryStringToAMongooseFindFilterBoolean</a></li><li data-type='method'><a href="module-helpers_jrh_mongo_filter.html#~convertReqQueryStringToAMongooseFindFilterGenericOperator">convertReqQueryStringToAMongooseFindFilterGenericOperator</a></li><li data-type='method'><a href="module-helpers_jrh_mongo_filter.html#~convertReqQueryStringToAMongooseFindFilterGenericOperatorResolveVal">convertReqQueryStringToAMongooseFindFilterGenericOperatorResolveVal</a></li><li data-type='method'><a href="module-helpers_jrh_mongo_filter.html#~convertReqQueryStringToAMongooseFindFilterMongoStrCmp">convertReqQueryStringToAMongooseFindFilterMongoStrCmp</a></li><li data-type='method'><a href="module-helpers_jrh_mongo_filter.html#~convertReqQueryStringToAMongooseFindFilterNumeric">convertReqQueryStringToAMongooseFindFilterNumeric</a></li><li data-type='method'><a href="module-helpers_jrh_mongo_filter.html#~convertReqQueryStringToAMongooseFindFilterStringic">convertReqQueryStringToAMongooseFindFilterStringic</a></li></ul></li><li><a href="module-helpers_jrh_ratelimiter.html">helpers/jrh_ratelimiter</a></li><li><a href="module-helpers_jrh_text.html">helpers/jrh_text</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrh_text.html#~capitalizeFirstLetter">capitalizeFirstLetter</a></li><li data-type='method'><a href="module-helpers_jrh_text.html#~jrBootstrapCollapseBox">jrBootstrapCollapseBox</a></li><li data-type='method'><a href="module-helpers_jrh_text.html#~jrHtmlFormInputPassword">jrHtmlFormInputPassword</a></li><li data-type='method'><a href="module-helpers_jrh_text.html#~jrHtmlFormOptionList">jrHtmlFormOptionList</a></li><li data-type='method'><a href="module-helpers_jrh_text.html#~jrHtmlFormOptionListSelect">jrHtmlFormOptionListSelect</a></li><li data-type='method'><a href="module-helpers_jrh_text.html#~jrHtmlNiceOptionFromList">jrHtmlNiceOptionFromList</a></li><li data-type='method'><a href="module-helpers_jrh_text.html#~jrHtmlStrigifyObject">jrHtmlStrigifyObject</a></li><li data-type='method'><a href="module-helpers_jrh_text.html#~jrPluralize">jrPluralize</a></li><li data-type='method'><a href="module-helpers_jrh_text.html#~jrPluralizeCount">jrPluralizeCount</a></li></ul></li><li><a href="module-helpers_jrh_validate.html">helpers/jrh_validate</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrh_validate.html#~validateInteger">validateInteger</a></li><li data-type='method'><a href="module-helpers_jrh_validate.html#~validateIntegerRange">validateIntegerRange</a></li><li data-type='method'><a href="module-helpers_jrh_validate.html#~validateJsonObjOrStringToObj">validateJsonObjOrStringToObj</a></li><li data-type='method'><a href="module-helpers_jrh_validate.html#~validateRealName">validateRealName</a></li><li data-type='method'><a href="module-helpers_jrh_validate.html#~validateString">validateString</a></li><li data-type='method'><a href="module-helpers_jrh_validate.html#~validateTrueFalse">validateTrueFalse</a></li></ul></li><li><a href="module-helpers_jrlog.html">helpers/jrlog</a><ul class='methods'><li data-type='method'><a href="module-helpers_jrlog.html#~aliasWinstonLogger">aliasWinstonLogger</a></li><li data-type='method'><a href="module-helpers_jrlog.html#~calcLogFilePath">calcLogFilePath</a></li><li data-type='method'><a href="module-helpers_jrlog.html#~createLogFileObj">createLogFileObj</a></li><li data-type='method'><a href="module-helpers_jrlog.html#~createWinstonLoggerObject">createWinstonLoggerObject</a></li><li data-type='method'><a href="module-helpers_jrlog.html#~getWinstonCategoryLogger">getWinstonCategoryLogger</a></li><li data-type='method'><a href="module-helpers_jrlog.html#~log">log</a></li><li data-type='method'><a href="module-helpers_jrlog.html#~logDefaultError">logDefaultError</a></li><li data-type='method'><a href="module-helpers_jrlog.html#~logExceptionError">logExceptionError</a></li><li data-type='method'><a href="module-helpers_jrlog.html#~logExceptionErrorWithMessage">logExceptionErrorWithMessage</a></li><li data-type='method'><a href="module-helpers_jrlog.html#~logMessage">logMessage</a></li><li data-type='method'><a href="module-helpers_jrlog.html#~logObject">logObject</a></li><li data-type='method'><a href="module-helpers_jrlog.html#~setup">setup</a></li><li data-type='method'><a href="module-helpers_jrlog.html#~setupMorganMiddlewareForExpressWebAccessLogging">setupMorganMiddlewareForExpressWebAccessLogging</a></li><li data-type='method'><a href="module-helpers_jrlog.html#~setupWinstonLogger">setupWinstonLogger</a></li></ul></li><li><a href="module-helpers_jrresult.html">helpers/jrresult</a></li><li><a href="module-models_app.html">models/app</a></li><li><a href="module-models_connection.html">models/connection</a></li><li><a href="module-models_file.html">models/file</a></li><li><a href="module-models_log.html">models/log</a></li><li><a href="module-models_login.html">models/login</a></li><li><a href="module-models_model_base_mongoose_minimal.html">models/model_base_mongoose_minimal</a></li><li><a href="module-models_modelBaseMongoose.html">models/modelBaseMongoose</a></li><li><a href="module-models_modqueue.html">models/modqueue</a></li><li><a href="module-models_option.html">models/option</a></li><li></li><li><a href="module-models_room.html">models/room</a></li><li><a href="module-models_roomdata.html">models/roomdata</a></li><li><a href="module-models_session.html">models/session</a></li><li><a href="module-models_subscription.html">models/subscription</a></li><li><a href="module-models_user.html">models/user</a></li><li><a href="module-models_verification.html">models/verification</a></li><li><a href="module-plugins_testplugin.html">plugins/testplugin</a></li><li></li><li></li><li><a href="module-routes_admin.html">routes/admin</a></li><li></li><li></li><li><a href="module-routes_analytics.html">routes/analytics</a></li><li><a href="module-routes_api_api.html">routes/api/api</a><ul class='methods'><li data-type='method'><a href="module-routes_api_api.html#~routerAllDos">routerAllDos</a></li><li data-type='method'><a href="module-routes_api_api.html#~routerAllHello">routerAllHello</a></li><li data-type='method'><a href="module-routes_api_api.html#~routerAllRefreshAccess">routerAllRefreshAccess</a></li><li data-type='method'><a href="module-routes_api_api.html#~routerAllReqRefreshSession">routerAllReqRefreshSession</a></li><li data-type='method'><a href="module-routes_api_api.html#~routerAllTokenTest">routerAllTokenTest</a></li><li data-type='method'><a href="module-routes_api_api.html#~routerGetIndex">routerGetIndex</a></li><li data-type='method'><a href="module-routes_api_api.html#~routerGetReqRefreshCredentials">routerGetReqRefreshCredentials</a></li><li data-type='method'><a href="module-routes_api_api.html#~routerPostReqRefreshCredentials">routerPostReqRefreshCredentials</a></li><li data-type='method'><a href="module-routes_api_api.html#~setupRouter">setupRouter</a></li></ul></li><li><a href="module-routes_api_app.html">routes/api/app</a><ul class='methods'><li data-type='method'><a href="module-routes_api_app.html#~setupRouter">setupRouter</a></li></ul></li><li><a href="module-routes_api_roomdata.html">routes/api/roomdata</a><ul class='methods'><li data-type='method'><a href="module-routes_api_roomdata.html#~setupRouter">setupRouter</a></li><li data-type='method'><a href="module-routes_api_roomdata.html#~setupRouter">setupRouter</a></li></ul></li><li></li><li><a href="module-routes_app.html">routes/app</a></li><li></li><li><a href="module-routes_index.html">routes/index</a></li><li><a href="module-routes_login.html">routes/login</a></li><li><a href="module-routes_logout.html">routes/logout</a></li><li><a href="module-routes_membersonly.html">routes/membersonly</a></li><li><a href="module-routes_profile.html">routes/profile</a></li><li><a href="module-routes_register.html">routes/register</a></li><li><a href="module-routes_room.html">routes/room</a></li><li><a href="module-routes_verify.html">routes/verify</a></li><li><a href="module-serverTests.html">serverTests</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">routes/api/api.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module routes/api/api
 * @author jesse reichler &lt;mouser@donationcoder.com>
 * @copyright 10/28/19
 * @description
 * ##### Overview
 * This file handles all requests related to the programmatic API interface for accessing the system.
 * These routes are all intended to be called programmatically by other code, and so should all return json replies.
*/

"use strict";


// modules
const express = require("express");


// requirement service locator
const jrequire = require("../../helpers/jrequire");

// controllers
const arserver = jrequire("arserver");

// helpers
const JrContext = require("../../helpers/jrcontext");
const jrhExpress = require("../../helpers/jrh_express");
const jrdebug = require("../../helpers/jrdebug");










//---------------------------------------------------------------------------
/**
 * Add the API routes
 *
 * @param {string} urlPath - the base path of these relative paths
 * @returns router object
 */
function setupRouter(urlPath) {
	// create express router
	const router = express.Router();

	// setup routes
	router.get("/", routerGetIndex);
	router.all("/reqrefreshsession", routerAllReqRefreshSession);
	router.get("/reqrefreshcredentials", routerGetReqRefreshCredentials);
	router.post("/reqrefreshcredentials", routerPostReqRefreshCredentials);
	router.all("/refreshaccess", routerAllRefreshAccess);
	router.all("/tokentest", routerAllTokenTest);
	router.all("/dos", routerAllDos);
	router.all("/hello", routerAllHello);

	// return router
	return router;
}
//---------------------------------------------------------------------------












//---------------------------------------------------------------------------
// router functions

/**
 * @description
 * Handle the request for the api index page,
 *  which currently just shows a web page index of links to all of the api functions.
 * @todo Replace the template with some json reply, since api should only be machine callable.
 */
async function routerGetIndex(req, res, next) {
	const jrContext = JrContext.makeNew(req, res, next);
	// just show index
	res.render("api/index", {
		jrResult: jrContext.mergeSessionMessages(),
	});
}



/**
 * @description
 * Test function, and just complains and checks for rate limiting.
 * ##### NOTES
 * * Currently this function is just used to test rate limiting for DOS type attacks.
 */
// test rate limiting of generic 404s at api route
async function routerAllDos(req, res, next) {
	const jrContext = JrContext.makeNew(req, res, next);
	// ATTN: test of rate limiting block
	const rateLimiter = arserver.getRateLimiterApi();
	// ATTN: NOTE that this is a PER-IP rate limit since we use rateLimiterKey = req.ip
	const rateLimiterKey = req.ip;
	//
	try {
		// ATTN: NOTE that this is a PER-IP rate limit since we use rateLimiterKey = req.ip
		await rateLimiter.consume(rateLimiterKey, 1);
	} catch (rateLimiterRes) {
		// rate limiter triggered
		jrhExpress.sendJsonError(jrContext, 429, "API rate limiting triggered; your ip has been blocked for " + (rateLimiter.blockDuration).toString() + " seconds.", "rateLimit");
		// exit from function
		return;
	}

	jrhExpress.sendJsonError(jrContext, 404, "API Route " + req.baseUrl + "/" + req.path + " not found.  API not implemented yet.", "404");
}



/**
 * @description
 * Present user with form for their username and password,
 * so they may request a long-lived Refresh token (JWT).
 * ##### NOTES
 * This route returns an html page (not json) and is used for user to fill in their credentials interactively; it may be unneeded since we expected api to be submitted programatically
 */
async function routerGetReqRefreshCredentials(req, res, next) {
	const jrContext = JrContext.makeNew(req, res, next);
	// render page
	res.render("api/tokenuserpassform", {
	});
}
//---------------------------------------------------------------------------




//---------------------------------------------------------------------------
/**
 * @description
 * This uses the user's current logged in session to generate a refresh token.
 * It might be preferable to having user manually authenticate their credentials to get one because it would allow them to log in via facebook, twitter, etc.
 *
 * @param {*} req
 * @param {*} res
 * @param {*} next
 */
async function routerAllReqRefreshSession(req, res, next) {
	const jrContext = JrContext.makeNew(req, res, next);

	if (!await arserver.requireRecentLoggedIn(jrContext, 60000)) {
		// errror and redirect will have happened
		return;
	}
	const user = await arserver.lookupLoggedInUser(jrContext);

	// success
	await renderRefreshTokenForUser(jrContext, user);
}
//---------------------------------------------------------------------------













//---------------------------------------------------------------------------
/**
 * @description
 * Process request for a long-lived Refresh token (JWT), after checking user's username and password in post data.
 * If username and password match, they will be issued a JWT refresh token that they can use to generate short-lived access tokens.
 * ##### Notes
 * * The IDEA is that the refresh token is coded with scope "api" and cannot be used to perform arbitrary actions on the site; it can only be used for api-like actions.
 * * The refresh token should only be used to request access tokens, which are short-lived tokens that can be use to perform actual api functions.
 */
async function routerPostReqRefreshCredentials(req, res, next) {
	const jrContext = JrContext.makeNew(req, res, next);
	// do a local test of passed username and password; DON'T store session info (i.e. don't actually log them in just look up user if they match password)
	// The reason we do this like this instead of trusting a logged in session user is so that this call can be made by a client that does not ever do session login
	const user = await arserver.asyncPassportManualNonSessionAuthenticateGetUser(jrContext, "local", "with username and password", next);
	if (jrContext.isError()) {
		arserver.renderErrorJson(jrContext, 401);
		return;
	}

	// success
	await renderRefreshTokenForUser(jrContext, user);
}


async function renderRefreshTokenForUser(jrContext, user) {
	const secureToken = await arserver.makeSecureTokenRefresh(user);

	// log request
	arserver.logr(jrContext, "api.token", "generated refresh token", null, user);

	// provide it
	jrhExpress.sendJsonDataSuccess(jrContext, "token generated", secureToken);
}



/**
 * @description
 * Make a short-lived (JWT) Access token, using a Refresh token.  Here the user passes us a Refresh token and we give them (after verifying it's validity) an Access token.
 * ##### NOTES
 * * see &lt;a href="https://scotch.io/@devGson/api-authentication-with-json-web-tokensjwt-and-passport">using refresh tokens with jwt&lt;/a>
 */
async function routerAllRefreshAccess(req, res, next) {
	const jrContext = JrContext.makeNew(req, res, next);

	// first the user has to give us a valid REFRESH token
	const [userPassport, user] = await arserver.asyncPassportManualNonSessionAuthenticateFromTokenInRequestGetPassportProfileAndUser(jrContext, next, "refresh");
	if (jrContext.isError()) {
		arserver.renderErrorJson(jrContext, 403);
		return;
	}

	// ok they gave us a valid refresh token, so now we generate an access token for them
	const secureToken = await arserver.makeSecureTokenAccessFromRefreshToken(user, userPassport.token);

	// log request
	arserver.logr(jrContext, "api.token", "refreshed access token", null, user);

	// provide it
	jrhExpress.sendJsonDataSuccess(jrContext, "token generated", secureToken);
}



/**
 * @description
 * Evaluate a refresh or access token, and report on its contents and validity; useful for testing.
 * @todo This should probably not be present in production version.
 */
async function routerAllTokenTest(req, res, next) {
	const jrContext = JrContext.makeNew(req, res, next);

	// retrieve/test the token passed by the user
	const userPassport = await arserver.asyncPassportManualNonSessionAuthenticateFromTokenInRequestGetMinimalPassportUsrData(jrContext, next, null);
	if (jrContext.isError()) {
		arserver.renderErrorJson(jrContext, 403);
		return;
	}

	// it's good
	// show them the userPassport data which will include .token
	const returnData = {
		token: userPassport.token,
	};
	jrhExpress.sendJsonDataSuccess(jrContext, "Valid token parsed in API test", returnData);
}
//---------------------------------------------------------------------------



//---------------------------------------------------------------------------
/**
 * @description
 * Just reply with a simple success message that a client could test for
 */
async function routerAllHello(req, res, next) {
	const jrContext = JrContext.makeNew(req, res, next);
	const returnData = {
		message: "hello world.",
		libVersion: arserver.getVersionLib(),
		apiVersion: arserver.getVersionApi(),
	};
	jrhExpress.sendJsonDataSuccess(jrContext, "Ok", returnData);
}
//---------------------------------------------------------------------------















module.exports = {
	setupRouter,
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Sun Jun 21 2020 11:32:02 GMT-0500 (Central Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
